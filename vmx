#!/bin/bash

# Find the .vmx directory in script directory or home directory
findCommandDir() {
    local scriptDir=$(dirname "$(readlink -f "$0")")

    if [[ -d "$scriptDir/.vmx" ]]; then
        echo "$scriptDir/.vmx"
        return 0
    fi

    if [[ -d "/opt/vmx" ]]; then
        echo "/opt/vmx"
        return 0
    fi

    return 1
}

commandDir=$(findCommandDir)
if [[ -z $commandDir ]]; then
    echo "ERROR: Could not find .vmx directory in current directory or any parent directory" >&2
    exit 1
fi

ROOT_REPO_DIR=$(dirname "$commandDir")

VMX_IMAGES_DIR="${VMX_IMAGES_DIR:-/var/lib/libvirt/images/vmx}"
VMX_CLOUDINIT_DIR="${VMX_CLOUDINIT_DIR:-/var/lib/libvirt/cloudinit/vmx}"
VMX_INSTANCES_DIR="${VMX_INSTANCES_DIR:-/var/lib/libvirt/instances/vmx}"

# Color definitions
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m' # No Color

printColor() {
    echo -e "$*"
}

logError() {
    echo -e "${CYAN}[$(date +'%Y-%m-%d %H:%M:%S')] ${RED}[ERROR]${NC} $*" >&2
}

logWarning() {
    echo -e "${CYAN}[$(date +'%Y-%m-%d %H:%M:%S')] ${YELLOW}[WARNING]${NC} $*" >&2
}

logInfo() {
    echo -e "${CYAN}[$(date +'%Y-%m-%d %H:%M:%S')] ${CYAN}[INFO]${NC} $*"
}

logSuccess() {
    echo -e "${CYAN}[$(date +'%Y-%m-%d %H:%M:%S')] ${GREEN}[SUCCESS]${NC} $*"
}

# Color printing functions
printRed() {
    printColor "${RED}$*${NC}"
}

printYellow() {
    printColor "${YELLOW}$*${NC}"
}

printCyan() {
    printColor "${CYAN}$*${NC}"
}

printGreen() {
    printColor "${GREEN}$*${NC}"
}

printBlue() {
    printColor "${BLUE}$*${NC}"
}

print() {
    printColor "$@"
}

printUsage() {
    print "${BOLD}vmx - libvirt VM manager with cloud-init support${NC}"
    print ""
    print "${BOLD}${CYAN}Usage:${NC} vmx <command> [action] [arguments]${NC}"

    if [[ ! -d $commandDir ]]; then
        printYellow "No commands available in: $commandDir"
        return 1
    fi

    print ""
    printYellow "Available Commands:"
    local dirs=$(find $commandDir/* -maxdepth 0 -type d 2>/dev/null | sort)

    if [[ -z $dirs ]]; then
        print "  (no commands available)"
        return 1
    fi

    for dir in $dirs; do
        printGreen "  $(basename $dir)"
    done
}

printSubCommandUsage() {
    local command=$1
    local cmd=$(basename "$1")
    print "${BOLD}Usage:${NC} ${CYAN}$0 $cmd <action> [arguments]${NC}"

    local actions=$(find $command/* -maxdepth 0 -type f -executable 2>/dev/null | sort)
    local commands=$(find $command/* -maxdepth 0 -type d -executable 2>/dev/null | sort)

    if [[ -z $actions && -z $commands ]]; then
        print "  (no actions or subcommands available)"
        exit 1
    fi

    if [[ -n $commands ]]; then
        print ""
        print "${BOLD}${CYAN}Sub commands:${NC}"
        for f in $commands; do
            printGreen "  $(basename $f)"
        done
    fi

    if [[ -n $actions ]]; then
        print ""
        print "${BOLD}${CYAN}Actions:${NC}"
        for f in $actions; do
            local fname=$(basename "$f")
            # Skip library files (starting with underscore)
            if [[ ! "$fname" =~ ^_ ]]; then
                printGreen "  $fname"
            fi
        done
    fi
}

if [ "$#" == "0" ]; then
    printUsage
    exit 1
fi

command="$commandDir/$1"
if [[ ! -d $command ]]; then
    printRed "No command available called '$1'!"
    printUsage
    exit 1
fi

shift

while (("$#")); do
    newCommand="$command/$1"

    if [[ -z $action ]]; then
        if [[ -d $newCommand ]]; then
            command=$newCommand
            shift
            continue
        fi

        if [[ -f $newCommand && -x $newCommand ]]; then
            action=$1
            shift
        else
            # Check if it's a help request
            if [[ "$1" == "--help" || "$1" == "-h" ]]; then
                printSubCommandUsage $command
                exit 0
            fi
            shift
        fi
    else
        args="$args $1"
        shift
    fi
done

if [[ -z $action ]]; then
    printSubCommandUsage $command
    exit 1
fi

# Export functions to child processes
export -f logError logWarning logInfo logSuccess printColor printRed printYellow printCyan printGreen printBlue print
export RED GREEN YELLOW BLUE CYAN BOLD NC ROOT_REPO_DIR VMX_IMAGES_DIR VMX_CLOUDINIT_DIR VMX_INSTANCES_DIR

cmd="$command/$action $args"
eval $cmd
