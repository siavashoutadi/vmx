#!/bin/bash

set -eo pipefail

if [[ "${1:-}" == "--help" || "${1:-}" == "-h" ]]; then
    cat <<EOF
${BOLD}SSH into a running VM${NC}

${BOLD}Usage:${NC} vmx vm ssh <vm_name>

${BOLD}Arguments:${NC}
  <vm_name>                    Name of the VM to connect to

${BOLD}Examples:${NC}
  vmx vm ssh myvm
  vmx vm ssh webserver
EOF
    exit 0
fi

if [[ -z "${1:-}" ]]; then
    printRed "VM name required"
    exit 1
fi

vm_name="$1"
ip=$(virsh domifaddr "${vm_name}" | grep ipv4 | awk '{print $4}' | cut -d/ -f1)

if [[ -z "$ip" ]]; then
    printRed "Could not get IP address for ${vm_name}"
    exit 1
fi

command ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -i "~/.ssh/id_rsa" "vmx@${ip}"
