#!/bin/bash

set -eo pipefail

_init_dirs() {
    sudo -u libvirt-qemu mkdir -p "${VMX_CLOUDINIT_DIR}/${1}"
}

_generate_userdata() {
    vm_name="$1"
    username="${2:-}"
    ssh_pubkey="${3:-}"
    packages="${4:-}"
    ansible_url="${5:-}"
    playbook="${6:-}"
    user_data_file="${VMX_CLOUDINIT_DIR}/${vm_name}/userdata.yaml"

    # Generate random password and create hash
    random_password=$(openssl rand -hex 8)
    password_hash=$(openssl passwd -6 "${random_password}")

    default_packages="git,ansible"
    if [[ -z "$packages" ]]; then
        packages="$default_packages"
    else
        packages="${packages},${default_packages}"
    fi
    # Build packages section if provided
    packages_section=""
    if [[ -n "$packages" ]]; then
        packages_section="packages:"
        IFS=',' read -ra pkg_array <<< "$packages"
        for pkg in "${pkg_array[@]}"; do
            # Trim whitespace
            pkg=$(echo "$pkg" | xargs)
            packages_section+=$'\n'"  - $pkg"
        done
        packages_section+=$'\n'
    fi

    # Build runcmd section for ansible-pull - now with defaults
    runcmd_section=""
    if [[ -n "$ansible_url" && -n "$playbook" ]]; then
        runcmd_section="  - ansible-pull -U \"${ansible_url}\" \"${playbook}\""
        runcmd_section+=$'\n'
    fi

    sudo -u libvirt-qemu bash -c "cat > ${user_data_file}" << EOF
#cloud-config
package_update: true
package_upgrade: true
${packages_section}
users:
  - name: rescue
    passwd: ${password_hash}
    sudo: ALL=(ALL) NOPASSWD:ALL
    shell: /bin/bash
    lock_passwd: false
    chpasswd: { expire: False }
    ssh_pwauth: True
  - name: ${username}
    sudo: ALL=(ALL) NOPASSWD:ALL
    shell: /bin/bash
    ssh_authorized_keys:
      - $(cat ${ssh_pubkey})

hostname: ${vm_name}
fqdn: ${vm_name}.local

runcmd:
  - systemctl enable ssh
  - systemctl start ssh
${runcmd_section}
EOF

    sudo -u libvirt-qemu bash -c "echo '${random_password}' > ${VMX_CLOUDINIT_DIR}/${vm_name}/rescue-password"

    printGreen "Generated userdata: ${user_data_file}"
    printGreen "Generated password file: ${VMX_CLOUDINIT_DIR}/${vm_name}/rescue-password"
}

_generate_metadata() {
    vm_name="$1"

    metadata_file="${VMX_CLOUDINIT_DIR}/${vm_name}/metadata.yaml"

    sudo -u libvirt-qemu bash -c "cat > $metadata_file" << EOF
instance-id: $(uuidgen)
local-hostname: ${vm_name}
EOF
    printGreen "Generated metadata: ${metadata_file}"
}

_show_cloudinit_files() {
    vm_name="$1"
    cloudinit_dir="${VMX_CLOUDINIT_DIR}/${vm_name}"

    if [[ -f "$cloudinit_dir/userdata.yaml" ]]; then
        print ""
        print "${CYAN}#####################################"
        print "######## ${BOLD}Cloud-init userdata ########"
        print "#####################################${NC}"
        print ""
        cat "${cloudinit_dir}/userdata.yaml"
    else
        print "  (no userdata file found)"
    fi

    if [[ -f "$cloudinit_dir/metadata.yaml" ]]; then
        print ""
        print "${CYAN}#####################################"
        print "######## ${BOLD}Cloud-init metadata ########"
        print "#####################################${NC}"
        print ""
        cat "${cloudinit_dir}/metadata.yaml"
    else
        print "  (no metadata file found)"
    fi
}
